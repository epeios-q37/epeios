<script>
  function getHexBitmap(canvas) {
    let ctx = canvas.getContext("2d");
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const pixels = imageData.data;

    const binaryPixels = [];
    for (let i = 0; i < pixels.length; i += 4) {
      const r = pixels[i];
      const g = pixels[i + 1];
      const b = pixels[i + 2];
      const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
      binaryPixels.push(luminance < 128 ? 1 : 0);
    }

    if (canvas.width % 4 !== 0) {
      throw new Error("QR code width is not a multiple of 4 pixels.");
    }

    let hexString = "";
    for (let i = 0; i < binaryPixels.length; i += 4) {
      let val = 0;
      for (let j = 0; j < 4; j++) {
        val |= (binaryPixels[i + j] << (3 - j));
      }
      hexString += val.toString(16);
    }

    return hexString;
  }

  async function QRCodeGenerate(data) {
    const url = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(data)}`;
    const img = new Image();
    img.crossOrigin = "Anonymous";

    const imageLoadPromise = new Promise((resolve, reject) => {
      img.onload = () => resolve();
      img.onerror = reject;
    });
    img.src = url;
    await imageLoadPromise;

    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);

    return getHexBitmap(canvas);
  }

  function QRCodeLaunch(text) {
    QRCodeGenerate(text)
      .then(hexString => {
        image = {
          pattern: hexString,
          width: 120,
          offsetX: 60,
          offsetY: 6,
          mul: 1
        };

        launchEvent(`${JSON.stringify(image)}|BUTTON|click||(Display)`);
      })
      .catch(e => console.error(e));
  }


  function getCenteredTextCoordinates(ctx, text, canvasWidth, canvasHeight, maxWidth) {
    const metrics = ctx.measureText(text);

    const ascent = metrics.actualBoundingBoxAscent || 0;
    const descent = metrics.actualBoundingBoxDescent || 0;
    const fullWidth = metrics.width;
    const textHeight = ascent + descent;
    const textWidth = Math.min(fullWidth, maxWidth);

    ctx.textAlign = 'start';

    const x = Math.floor(Math.max((canvasWidth - textWidth) / 2, 0));

    const y = Math.floor((canvasHeight / 2) + (ascent - textHeight / 2));

    return { x, y };
  }



  function createTextCanvas(canvasId, text, x, y, width, font, fontSize, centerX, centerY) {
    canvas = document.getElementById(canvasId);

    const ctx = canvas.getContext('2d');

    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    /* const fontSize = Math.floor(height * 0.6); */
    ctx.font = `${fontSize}px ${font}`;

    ctx.textAlign = 'left';
    ctx.textBaseline = 'bottom';

    ctx.fillStyle = 'black';

    let centeredX = 0, centeredY = 0;

    const centeredCoords = getCenteredTextCoordinates(ctx, text, canvas.width, canvas.height, width);

    x = centerX ? centeredCoords['x'] : x;
    y = centerY ? centeredCoords['y'] : y;

    ctx.fillText(text, x, y, width);

    return { x, y };
  }


  function displayText(canvasId, text, x, y, width, font, fontSize, coeff, centerX, centerY) {
    canvas = document.getElementById(canvasId);

    image = {
      pattern: getHexBitmap(canvas),
      width: canvas.width,
      offsetX: 0,
      offsetY: 0,
      mul: 1
    };

    launchEvent(`${JSON.stringify(image)}|BUTTON|click||(Display)`);
  }

</script>